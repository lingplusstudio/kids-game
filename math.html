<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¹¼å…’æ•¸å­¸å°å¤©æ‰</title>
   <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #F3E5F5; text-align: center; padding: 10px; margin: 0; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
        
        h1 { color: #558B2F; margin: 5px 0; font-size: 1.2rem; display: inline-block; vertical-align: middle; }
        .score-board { display: inline-block; background: #FFEB3B; padding: 4px 12px; border-radius: 10px; border: 2px solid #FBC02D; font-weight: bold; font-size: 0.9rem; margin-left: 10px; vertical-align: middle; }
.mute-btn {
    position: fixed;
    top: 10px;
    right: 10px; /* æ”¾åœ¨å³ä¸Šè§’ */
    width: 70px;
    height: 70px;
    background-color: #FF9800;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.5rem;
    z-index: 9999;
    box-shadow: 0 4px #E65100;
    display: flex;
    align-items: center;
    justify-content: center;
}
.mute-btn:active {
    transform: translateY(2px);
    box-shadow: 0 1px #E65100;
}
        /* ğŸŒŸ è®“é›£åº¦æŒ‘æˆ°æŒ‰éˆ•æ’æ›´æœ‰ç©ºé–“ */
        .level-select { 
            margin: 15px 0 25px 0; /* å¢åŠ ä¸‹æ–¹èˆ‡é¡Œç›®çš„è·é›¢ */
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .lvl-btn { padding: 8px 15px; border-radius: 10px; border: 2px solid #8BC34A; background: white; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.3s; }
        .lvl-btn.active { background: #8BC34A !important; color: white !important; }

        /* ğŸŒŸ è®“æ•¸å­¸é¡Œç›®å€åŸŸä¸Šä¸‹æ’é–‹ */
        .math-row { 
            display: flex; 
            justify-content: center; 
            align-items: center; /* ç½®ä¸­å°é½Šç¬¦è™Ÿ */
            gap: 15px; 
            margin: 25px 0; /* å¢åŠ èˆ‡æŒ‰éˆ•å€çš„å‚ç›´è·é›¢ */
        }
        
        .item-group { display: flex; flex-direction: column; align-items: center; width: 200px; } 
        
        .plate { 
            background: #FFFDE7; 
            border: 3px dashed #FFCA28; 
            border-radius: 20px; 
            width: 180px;      
            height: 140px; /* ç¨å¾®é•·é«˜ä¸€é» */
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            padding: 8px; 
            transition: all 0.2s; 
        }

        /* ğŸŒŸ è®“ç›¤å­ä¸‹æ–¹çš„æ•¸å­—æ¨™ç±¤æ›´æœ‰è·é›¢æ„Ÿ */
        .number-label { 
            font-size: 2.4rem; 
            color: #558B2F; 
            font-weight: bold; 
            margin-top: 12px; /* æ•¸å­—èˆ‡ç›¤å­ä¸è¦è²¼å¤ªè¿‘ */
            height: 45px; 
        }

        .symbol { font-size: 3.5rem; font-weight: 900; color: #2E7D32; margin-top: -30px; width: 50px; }

        /* ğŸŒŸ ç­”æ¡ˆé¸é …å€ */
        .options { 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin: 20px 0; 
            max-width: 450px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .num-btn { width: 62px; height: 62px; font-size: 1.7rem; cursor: pointer; border-radius: 18px; border: none; background: #8BC34A !important; color: white !important; box-shadow: 0 5px #689F38; font-weight: bold; }
        .num-btn:active { transform: translateY(2px); box-shadow: 0 1px #689F38; }

        #message { font-size: 1.3rem; height: 30px; color: #E91E63; font-weight: bold; margin: 15px 0; }
        .next-btn { padding: 12px 45px; font-size: 1.3rem; cursor:pointer; border-radius: 50px; background: #33691E; color: white; border: none; box-shadow: 0 5px #1B5E20; font-weight: bold; margin-bottom: 15px; }
        
        /* ğŸŒŸ æ”¾å¤§å¾Œçš„å›é¦–é æŒ‰éˆ• */
        .home-btn-large { 
            position: fixed; 
            top: 10px; 
            left: 10px; 
            width: 70px;  /* å¾ 50px æ”¾å¤§åˆ° 70px */
            height: 70px; /* å¾ 50px æ”¾å¤§åˆ° 70px */
            background-color: #9C27B0; 
            color: white; 
            text-decoration: none; 
            border-radius: 15px; /* åœ“è§’ä¹ŸåŠ æ·±ä¸€é»é» */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            font-weight: bold; 
            font-size: 0.9rem; /* æ–‡å­—æ”¾å¤§ */
            opacity: 0.9; 
            box-shadow: 0 4px #7B1FA2; /* åŠ å€‹é™°å½±æ›´æœ‰æŒ‰éˆ•æ„Ÿ */
        }

        /* è®“æŒ‰éˆ•è£¡çš„ ğŸ  åœ–æ¡ˆå¤§ä¸€é» (å¦‚æœæœ‰ç”¨çš„è©±) */
        .home-btn-large span {
            font-size: 1.8rem !important;
            margin-bottom: 2px;
        }
        /* ç•¶ iPad æ©«è‘—æ‹¿æ™‚çš„å„ªåŒ– */
        @media (orientation: landscape) {
            .container { padding: 15px 30px; }
            .game-area {
                display: flex;
                justify-content: center; 
                align-items: center;
                gap: 40px; /* å¢åŠ å·¦å³å…©é‚Šçš„è·é›¢ */
                margin-top: 10px;
            }
            .button-panel {
                width: 45%; 
            }
            .visual-display {
                width: 45%; 
            }
            .math-row { margin: 15px 0; }
        }
    </style>
</head>
<body>

<a href="index.html" class="home-btn-large" onclick="stopSpeech()">
    <span>ğŸ </span>é¦–é 
</a>
<button id="mute-btn" onclick="toggleMute()" class="mute-btn">
    <span id="mute-icon">ğŸ”Š</span>
</button>
<div class="container">
<div id="start-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px;">
    <h2 style="color: #558B2F;">æº–å‚™å¥½ç•¶æ•¸å­¸å°å¤©æ‰äº†å—ï¼Ÿ</h2>
    <button class="next-btn" onclick="initGame()" style="background: #FF9800; box-shadow: 0 4px #F57C00;">é»æˆ‘é–‹å§‹ ğŸ®</button>
</div>
    <h1>ğŸŒŸ æ•¸å­¸å°å¤©æ‰ ğŸŒŸ</h1>
    <div class="score-board">â­ ç­”å°ï¼š<span id="score">0</span></div>

    <div class="level-select">
        <button class="lvl-btn active" onclick="changeLevel(1, this)">åˆç´šç·´ç¿’</button>
        <button class="lvl-btn" onclick="changeLevel(2, this)">ä¸­ç´šç·´ç¿’</button>
        <button class="lvl-btn" onclick="changeLevel(3, this)">é«˜ç´šæŒ‘æˆ°</button>
        <button class="lvl-btn" onclick="changeLevel(4, this)" style="border-color: #E91E63; color: #E91E63;">çµ‚æ¥µæŒ‘æˆ°</button>
    </div>

    <div class="math-row">
        <div class="item-group">
            <div id="left-plate" class="plate"></div>
            <div id="left-num" class="number-label"></div>
        </div>
        <div id="operator" class="symbol">+</div>
        <div class="item-group">
            <div id="right-plate" class="plate"></div>
            <div id="right-num" class="number-label"></div>
        </div>
        <div class="symbol">=</div>
        <div class="item-group">
            <div id="result-plate" class="plate" style="color: #ccc;">?</div>
            <div id="result-label" class="number-label" style="color: #ccc;">?</div>
        </div>
    </div>

    <div id="message"></div>
    <div class="options" id="button-area"></div>
    <button class="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ ğŸš€</button>
</div>

<script>
    let answer = 0;
    let currentLevel = 1; 
    let score = 0;
    let canAnswer = true;

    // ğŸŒŸ åŠŸèƒ½1ï¼šç”¢ç”Ÿæ¨™æº– 5 é¡†ä¸€åˆ—çš„ HTML (åŠ æ³•èˆ‡çµæœç”¨)
    function getFruitHTML(icon, count) {
        if (count === 0) return "";
        let html = '';
        for (let i = 1; i <= count; i++) {
            html += icon;
            if (i % 5 === 0 && i !== count) html += '<br>'; // æ»¿5é¡†å°±æ›è¡Œ
        }
        return `<div style="line-height: 1.4; letter-spacing: 2px; text-align: center;">${html}</div>`;
    }

    // ğŸŒŸ åŠŸèƒ½2ï¼šç”¢ç”Ÿæ¸›æ³•ã€Œæš—è‰²èˆ‡äº®è‰²ã€æ··åˆçš„ 5 é¡†ä¸€åˆ— HTML (ä¿®æ­£ç‰ˆ)
    function getSubtractionMiddleHTML(icon, total, darkCount) {
        if (total === 0) return "";
        let darkStr = '';
        let brightStr = '';
        for (let i = 1; i <= total; i++) {
            let fruit = icon;
            if (i % 5 === 0 && i !== total) fruit += '<br>'; // æ»¿5é¡†å°±æ›è¡Œ
            
            if (i <= darkCount) darkStr += fruit;
            else brightStr += fruit;
        }
        
        let result = `<div style="line-height: 1.4; letter-spacing: 2px; text-align: center;">`;
        // è¢«æ¸›æ‰çš„éƒ¨åˆ†ï¼šé€æ˜ + åˆªé™¤ç·š
        if (darkCount > 0) {
            result += `<span style="opacity: 0.3; text-decoration: line-through;">${darkStr}</span>`;
        }
        // ğŸŒŸ å‰©ä¸‹çš„éƒ¨åˆ†ï¼šç›´æ¥é¡¯ç¤ºæ­£å¸¸äº®åº¦ï¼Œç§»é™¤ç´…æ¡†å’Œç®­é ­
        if (total > darkCount) {
            result += brightStr;
        }
        result += `</div>`;
        return result;
    }

    function changeLevel(lvl, btn) {
        currentLevel = lvl;
        document.querySelectorAll('.lvl-btn').forEach(b => {
            b.classList.remove('active');
            if(b.innerText === 'çµ‚æ¥µæŒ‘æˆ°') b.style.color = '#E91E63'; 
        });
        btn.classList.add('active');
        if(lvl === 4) btn.style.color = 'white'; 
        nextQuestion();
    }

// åœ¨è…³æœ¬æœ€ä¸Šæ–¹å®šç¾©é–‹é—œè®Šæ•¸
    let isMuted = false;

    // èªéŸ³é–‹é—œåˆ‡æ›å‡½æ•¸
    function toggleMute() {
        isMuted = !isMuted;
        const icon = document.getElementById('mute-icon');
        const btn = document.getElementById('mute-btn');
        
        if (isMuted) {
            icon.innerText = 'ğŸ”‡';
            btn.style.backgroundColor = '#9e9e9e'; // è®Šç°è‰²
            btn.style.boxShadow = '0 4px #757575';
            window.speechSynthesis.cancel(); // é—œé–‰æ™‚ç«‹åˆ»åœæ­¢ç›®å‰æ­£åœ¨èªªçš„è©±
        } else {
            icon.innerText = 'ğŸ”Š';
            btn.style.backgroundColor = '#FF9800'; // è®Šæ©˜è‰²
            btn.style.boxShadow = '0 4px #E65100';
            speak("èªéŸ³å·²é–‹å•Ÿ"); // é–‹å•Ÿæ™‚çµ¦å€‹æç¤º
        }
    }

    // ğŸŒŸ æ•´åˆå¾Œçš„ speak å‡½æ•¸
    function speak(text) {
        // å¦‚æœç›®å‰æ˜¯éœéŸ³æ¨¡å¼ï¼Œå°±ç›´æ¥æ”¶å·¥ï¼Œä»€éº¼éƒ½ä¸åš
        if (isMuted) return;

        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        
        // å–å¾—ç³»çµ±æ‰€æœ‰è€å¸«æ¸…å–®
        const voices = window.speechSynthesis.getVoices();
        
        // ğŸŒŸ é–å®šå¦³è¦çš„è€å¸« (é›»è…¦ Zhiwei / iPad ç”·è²)
        let targetVoice = voices.find(v => v.name.includes("Zhiwei"));

        if (!targetVoice) {
            targetVoice = voices.find(v => 
                v.name.includes("æç‰§") || 
                v.name.includes("å½¬å½¬") || 
                v.name.includes("æ³¢æ³¢") ||
                v.name.includes("Male")
            );
        }

        if (targetVoice) {
            msg.voice = targetVoice;
        }

        msg.lang = 'zh-TW';
        msg.rate = 0.8; // é€Ÿåº¦ 0.8 å°å°æœ‹å‹ä¾†èªªæ¯”è¼ƒå‰›å¥½
        msg.pitch = 1.0; 
        window.speechSynthesis.speak(msg);
    }
// å¼·åˆ¶åœæ­¢æ‰€æœ‰èªéŸ³çš„å‡½æ•¸
function stopSpeech() {
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
}

// ğŸŒŸ é€²éšä¿éšªï¼šç•¶é é¢è·³è½‰ã€é—œé–‰æˆ–é‡æ–°æ•´ç†æ™‚ï¼Œè‡ªå‹•åœæ­¢èªéŸ³
window.onbeforeunload = function() {
    window.speechSynthesis.cancel();
};
    // é€™è¡Œç¢ºä¿è€å¸«æ¸…å–®æœ‰è¼‰å…¥å®Œæˆ
    window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
    };

    function nextQuestion() {
        canAnswer = true;
        document.getElementById('message').innerText = "";
        const resultPlate = document.getElementById('result-plate');
        const resultLabel = document.getElementById('result-label');
        
        resultPlate.innerText = "?";
        resultPlate.style.color = "#ccc";
        resultPlate.style.fontSize = "3rem";

        if (currentLevel >= 3) {
            resultLabel.innerHTML = "&nbsp;"; 
        } else {
            resultLabel.innerText = "?";
            resultLabel.style.color = "#ccc";
        }

        let isSubtraction = Math.random() > 0.5;
        let n1, n2;

       if (currentLevel === 1) {
            n1 = Math.floor(Math.random() * 5) + 1;
            n2 = Math.floor(Math.random() * (isSubtraction ? n1 : (5 - n1))) + 1;
        } else if (currentLevel === 2) {
            // ğŸŒŸ é€²éšæ¨¡å¼ï¼šèª¿æ•´ç‚º 17 ä»¥å…§
            if (isSubtraction) {
                n1 = Math.floor(Math.random() * 11) + 7; // n1 ç¯„åœåœ¨ 7~17
                n2 = Math.floor(Math.random() * n1) + 1; // n2 ä¸è¶…é n1
            } else {
                n1 = Math.floor(Math.random() * 13) + 1; // n1 ç¯„åœ 1~13
                n2 = Math.floor(Math.random() * (17 - n1)) + 1; // ç¢ºä¿ç›¸åŠ æœ€é«˜ 17
            }
        } else if (currentLevel === 3) {
            n1 = Math.floor(Math.random() * 11) + 10; 
            n2 = Math.floor(Math.random() * (isSubtraction ? (n1 - 1) : 5)) + 1;
        } else {
            if (isSubtraction) {
                n1 = Math.floor(Math.random() * 31) + 20; 
                n2 = Math.floor(Math.random() * (n1 - 10)) + 10; 
            } else {
                n1 = Math.floor(Math.random() * 31) + 10;
                n2 = Math.floor(Math.random() * 31) + 10;
            }
        }

        const lp = document.getElementById('left-plate');
        const rp = document.getElementById('right-plate');
        const ln = document.getElementById('left-num');
        const rn = document.getElementById('right-num');
        const op = document.getElementById('operator');

        if (isSubtraction) {
            answer = n1 - n2;
            op.innerText = "-";
            if (currentLevel >= 3) {
                lp.innerText = n1;
                rp.innerText = n2;
                // ğŸŒŸ ç§»é™¤ titleï¼Œç›´æ¥å”¸é¡Œç›®
                speak(`${n1} æ¸› ${n2} ç­‰æ–¼å¤šå°‘ï¼Ÿ`);
            } else {
                lp.innerHTML = getFruitHTML("ğŸ", n1);
                rp.innerHTML = getSubtractionMiddleHTML("ğŸ", n1, n2);
                speak(`${n1} æ¸› ${n2} ç­‰æ–¼å¤šå°‘ï¼Ÿ`);
            }
        } else {
            answer = n1 + n2;
            op.innerText = "+";
            if (currentLevel >= 3) {
                lp.innerText = n1;
                rp.innerText = n2;
                // ğŸŒŸ ç§»é™¤ titleï¼Œç›´æ¥å”¸é¡Œç›®
                speak(`${n1} åŠ  ${n2} ç­‰æ–¼å¤šå°‘ï¼Ÿ`);
            } else {
                lp.innerHTML = getFruitHTML("ğŸŠ", n1);
                rp.innerHTML = getFruitHTML("ğŸŠ", n2);
                speak(`${n1} åŠ  ${n2} ç­‰æ–¼å¤šå°‘ï¼Ÿ`);
            }
        }

        if (currentLevel >= 3) {
            lp.style.fontSize = "4.5rem";
            rp.style.fontSize = "4.5rem";
            ln.innerHTML = "&nbsp;"; 
            rn.innerHTML = "&nbsp;";
        } else {
            // ğŸŒŸ å­—é«”å›ºå®šï¼Œé…åˆ5é¡†æ›è¡Œ
            lp.style.fontSize = "1.6rem";
            rp.style.fontSize = "1.6rem";
            ln.innerText = n1;
            rn.innerText = n2;
        }

        let choices = [answer];
        let range = 15;
        if (currentLevel === 3) range = 30;
        if (currentLevel === 4) range = 100; 

        while(choices.length < 6) {
            let wrong;
            if (currentLevel === 4) {
                wrong = answer + Math.floor(Math.random() * 20) - 10;
                if (wrong < 0) wrong = Math.floor(Math.random() * 40) + 1; 
            } else {
                wrong = Math.floor(Math.random() * range);
            }
            if(!choices.includes(wrong)) choices.push(wrong);
        }
        choices.sort((a, b) => a - b);
        let btnHTML = "";
        choices.forEach(num => {
            btnHTML += `<button class="num-btn" onclick="check(${num}, this)">${num}</button>`;
        });
        document.getElementById('button-area').innerHTML = btnHTML;
    }

    function check(num, btn) {
        if (!canAnswer) return;
        if (num === answer) {
            score++;
            document.getElementById('score').innerText = score;
            document.getElementById('message').innerText = "ğŸŒŸ ç­”å°äº†ï¼å¦³å¥½æ£’ï¼";
            btn.style.backgroundColor = "#2E7D32";
            canAnswer = false;
            const resultPlate = document.getElementById('result-plate');
            const resultLabel = document.getElementById('result-label');
            
            if (currentLevel >= 3) {
                resultPlate.innerText = answer;
                resultPlate.style.fontSize = "4.5rem";
                resultLabel.innerHTML = "&nbsp;";
            } else {
                let currentOperator = document.getElementById('operator').innerText;
                let icon = (currentOperator === "-") ? "ğŸ" : "ğŸŠ";
                
                // ğŸŒŸ ç­”å°æ™‚ï¼Œçµæœæ¡†ä¹Ÿä½¿ç”¨ 5é¡†ä¸€åˆ— çš„æ’åˆ—æ³•
                resultPlate.style.fontSize = "1.6rem";
                resultPlate.innerHTML = getFruitHTML(icon, answer);
                resultLabel.innerText = answer;
            }
            resultPlate.style.color = "#33691E";
            resultLabel.style.color = "#33691E";
            speak(`ç­”å°äº†! ç­”æ¡ˆå°±æ˜¯ ${answer}`);
        } else {
            document.getElementById('message').innerText = "å†ç®—ç®—çœ‹å–”ï¼";
            btn.style.setProperty('background-color', '#C62828', 'important');
            speak("å†ç®—ç®—çœ‹å–”");
        }
    }

    function initGame() {
        speak("æ­¡è¿ä¾†åˆ°æ•¸å­¸æŒ‘æˆ°è³½ï¼");
        setTimeout(nextQuestion, 4500);
        document.getElementById('start-overlay').style.display = 'none';
    }
</script>
</body>
</html>